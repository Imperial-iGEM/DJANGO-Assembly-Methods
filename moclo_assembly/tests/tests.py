import unittest
from unittest.mock import patch
import sys
import os
import pandas as pd
# sys.path.append("C:/Users/gabri/Documents/Uni/iGEM/OT2-MoClo-Transformation-Ecoli-master/moclo_transformation/final_version")
sys.path.append("/home/runner/work/DJANGO-Assembly-Methods/DJANGO-Assembly-Methods/moclo_assembly/moclo_transformation/")
import moclo_transform_generator

# TEST_DIR = "C:/Users/gabri/Documents/Uni/iGEM/OT2-MoClo-Transformation-Ecoli-master/moclo_transformation/final_version/tests"
TEST_DIR = "/home/runner/work/DJANGO-Assembly-Methods/DJANGO-Assembly-Methods/moclo_assembly/tests/"


class MoCloInputTestCase(unittest.TestCase):

    def setUp(self):
        self.dna_plate_map_dict = {"input-dna-map": [["I13453_AB-1", "I13453_AB-2", "I13453_AB-4", "B0034m_BC-1", "C0012m_CD-1", "C0012m_CD-2", "C0012m_CD-4", "E0040m_C1N-1", "E0040m_C1N-2", "E0040m_C1N-4"], ["J23100_AB-1", "J23100_AB-2", "J23100_AB-4", "B0034m_BC-2", "C0040_CD-1", "C0040_CD-2", "C0040_CD-4", "3xFLAG_CC1-1", "3xFLAG_CC1-2", "3xFLAG_CC1-4"], ["J23102_AB-1", "J23102_AB-2", "J23102_AB-4", "B0034m_BC-4", "C0062_CD-1", "C0062_CD-2", "C0062_CD-4", "12 aa GS Linker_NO-1", "12 aa GS Linker_NO-2", "12 aa GS Linker_NO-4"], ["J23103_AB-1", "J23103_AB-2", "J23103_AB-4", "B0015_DE-1", "C0080_CD-1", "C0080_CD-2", "C0080_CD-4", "6xHIS_OD-1", "6xHIS_OD-2", "6xHIS_OD-4"], ["J23106_AB-1", "J23106_AB-2", "J23106_AB-4", "B0015_DE-2", "E0030_CD-1", "E0030_CD-2", "E0030_CD-4", "DVK_AE-1", "DVK_AE-2", "DVK_AE-4"], ["J23107_AB-1", "J23107_AB-2", "J23107_AB-4", "B0015_DE-4", "E0040m_CD-1", "E0040m_CD-2", "E0040m_CD-4", "DVK_CD-1", "DVK_CD-2", "DVK_CD-4"], ["J23116_AB-1", "J23116_AB-2", "J23116_AB-4", "", "E1010m_CD-1", "E1010m_CD-2", "E1010m_CD-4", "", "", ""], ["R0040_AB-1", "R0040_AB-2", "R0040_AB-4", "", "deGFP_CD-1", "deGFP_CD-2", "deGFP_CD-4", "", "", ""]]}
        self.combinations_to_make = [{"name": "2-E0040m-1", "parts": ["E0040m_CD-1", "DVK_CD-1"]}, {"name": "2-C0012m-1", "parts": ["C0012m_CD-1", "DVK_CD-1"]}, {"name": "2-C0040-1", "parts": ["C0040_CD-1", "DVK_CD-1"]}, {"name": "2-C0062-1", "parts": ["C0062_CD-1", "DVK_CD-1"]}, {"name": "2-C0080-1", "parts": ["C0080_CD-1", "DVK_CD-1"]}, {"name": "2-E0030-1", "parts": ["E0030_CD-1", "DVK_CD-1"]}, {"name": "2-E1010m-1", "parts": ["E1010m_CD-1", "DVK_CD-1"]}, {"name": "2-deGFP-1", "parts": ["deGFP_CD-1", "DVK_CD-1"]}, {"name": "2-E0040m-2", "parts": ["E0040m_CD-2", "DVK_CD-2"]}, {"name": "2-C0012m-2", "parts": ["C0012m_CD-2", "DVK_CD-2"]}, {"name": "2-C0040-2", "parts": ["C0040_CD-2", "DVK_CD-2"]}, {"name": "2-C0062-2", "parts": ["C0062_CD-2", "DVK_CD-2"]}, {"name": "2-C0080-2", "parts": ["C0080_CD-2", "DVK_CD-2"]}, {"name": "2-E0030-2", "parts": ["E0030_CD-2", "DVK_CD-2"]}, {"name": "2-E1010m-2", "parts": ["E1010m_CD-2", "DVK_CD-2"]}, {"name": "2-deGFP-2", "parts": ["deGFP_CD-2", "DVK_CD-2"]}, {"name": "2-E0040m-4", "parts": ["E0040m_CD-4", "DVK_CD-4"]}, {"name": "2-C0012m-4", "parts": ["C0012m_CD-4", "DVK_CD-4"]}, {"name": "2-C0040-4", "parts": ["C0040_CD-4", "DVK_CD-4"]}, {"name": "2-C0062-4", "parts": ["C0062_CD-4", "DVK_CD-4"]}, {"name": "2-C0080-4", "parts": ["C0080_CD-4", "DVK_CD-4"]}, {"name": "2-E0030-4", "parts": ["E0030_CD-4", "DVK_CD-4"]}, {"name": "2-E1010m-4", "parts": ["E1010m_CD-4", "DVK_CD-4"]}, {"name": "2-deGFP-4", "parts": ["deGFP_CD-4", "DVK_CD-4"]}, {"name": "5-J23106-1", "parts": ["J23106_AB-1", "B0034m_BC-1", "E0040m_CD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "5-I13453-1", "parts": ["I13453_AB-1", "B0034m_BC-1", "E0040m_CD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "5-J23100-1", "parts": ["J23100_AB-1", "B0034m_BC-1", "E0040m_CD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "5-J23102-1", "parts": ["J23102_AB-1", "B0034m_BC-1", "E0040m_CD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "5-J23103-1", "parts": ["J23103_AB-1", "B0034m_BC-1", "E0040m_CD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "5-J23107-1", "parts": ["J23107_AB-1", "B0034m_BC-1", "E0040m_CD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "5-J23116-1", "parts": ["J23116_AB-1", "B0034m_BC-1", "E0040m_CD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "5-R0040-1", "parts": ["R0040_AB-1", "B0034m_BC-1", "E0040m_CD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "5-J23106-2", "parts": ["J23106_AB-2", "B0034m_BC-2", "E0040m_CD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "5-I13453-2", "parts": ["I13453_AB-2", "B0034m_BC-2", "E0040m_CD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "5-J23100-2", "parts": ["J23100_AB-2", "B0034m_BC-2", "E0040m_CD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "5-J23102-2", "parts": ["J23102_AB-2", "B0034m_BC-2", "E0040m_CD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "5-J23103-2", "parts": ["J23103_AB-2", "B0034m_BC-2", "E0040m_CD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "5-J23107-2", "parts": ["J23107_AB-2", "B0034m_BC-2", "E0040m_CD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "5-J23116-2", "parts": ["J23116_AB-2", "B0034m_BC-2", "E0040m_CD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "5-R0040-2", "parts": ["R0040_AB-2", "B0034m_BC-2", "E0040m_CD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "5-J23106-4", "parts": ["J23106_AB-4", "B0034m_BC-4", "E0040m_CD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "5-I13453-4", "parts": ["I13453_AB-4", "B0034m_BC-4", "E0040m_CD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "5-J23100-4", "parts": ["J23100_AB-4", "B0034m_BC-4", "E0040m_CD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "5-J23102-4", "parts": ["J23102_AB-4", "B0034m_BC-4", "E0040m_CD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "5-J23103-4", "parts": ["J23103_AB-4", "B0034m_BC-4", "E0040m_CD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "5-J23107-4", "parts": ["J23107_AB-4", "B0034m_BC-4", "E0040m_CD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "5-J23116-4", "parts": ["J23116_AB-4", "B0034m_BC-4", "E0040m_CD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "5-R0040-4", "parts": ["R0040_AB-4", "B0034m_BC-4", "E0040m_CD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "8--J23106-1", "parts": ["J23106_AB-1", "B0034m_BC-1", "3xFLAG_CC1-1", "E0040m_C1N-1", "12 aa GS Linker_NO-1", "6xHIS_OD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "8-I13453-1", "parts": ["I13453_AB-1", "B0034m_BC-1", "3xFLAG_CC1-1", "E0040m_C1N-1", "12 aa GS Linker_NO-1", "6xHIS_OD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "8-J23100-1", "parts": ["J23100_AB-1", "B0034m_BC-1", "3xFLAG_CC1-1", "E0040m_C1N-1", "12 aa GS Linker_NO-1", "6xHIS_OD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "8-J23102-1", "parts": ["J23102_AB-1", "B0034m_BC-1", "3xFLAG_CC1-1", "E0040m_C1N-1", "12 aa GS Linker_NO-1", "6xHIS_OD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "8-J23103-1", "parts": ["J23103_AB-1", "B0034m_BC-1", "3xFLAG_CC1-1", "E0040m_C1N-1", "12 aa GS Linker_NO-1", "6xHIS_OD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "8-J23107-1", "parts": ["J23107_AB-1", "B0034m_BC-1", "3xFLAG_CC1-1", "E0040m_C1N-1", "12 aa GS Linker_NO-1", "6xHIS_OD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "8-J23116-1", "parts": ["J23116_AB-1", "B0034m_BC-1", "3xFLAG_CC1-1", "E0040m_C1N-1", "12 aa GS Linker_NO-1", "6xHIS_OD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "8-R0040-1", "parts": ["R0040_AB-1", "B0034m_BC-1", "3xFLAG_CC1-1", "E0040m_C1N-1", "12 aa GS Linker_NO-1", "6xHIS_OD-1", "B0015_DE-1", "DVK_AE-1"]}, {"name": "8--J23106-2", "parts": ["J23106_AB-2", "B0034m_BC-2", "3xFLAG_CC1-2", "E0040m_C1N-2", "12 aa GS Linker_NO-2", "6xHIS_OD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "8-I13453-2", "parts": ["I13453_AB-2", "B0034m_BC-2", "3xFLAG_CC1-2", "E0040m_C1N-2", "12 aa GS Linker_NO-2", "6xHIS_OD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "8-J23100-2", "parts": ["J23100_AB-2", "B0034m_BC-2", "3xFLAG_CC1-2", "E0040m_C1N-2", "12 aa GS Linker_NO-2", "6xHIS_OD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "8-J23102-2", "parts": ["J23102_AB-2", "B0034m_BC-2", "3xFLAG_CC1-2", "E0040m_C1N-2", "12 aa GS Linker_NO-2", "6xHIS_OD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "8-J23103-2", "parts": ["J23103_AB-2", "B0034m_BC-2", "3xFLAG_CC1-2", "E0040m_C1N-2", "12 aa GS Linker_NO-2", "6xHIS_OD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "8-J23107-2", "parts": ["J23107_AB-2", "B0034m_BC-2", "3xFLAG_CC1-2", "E0040m_C1N-2", "12 aa GS Linker_NO-2", "6xHIS_OD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "8-J23116-2", "parts": ["J23116_AB-2", "B0034m_BC-2", "3xFLAG_CC1-2", "E0040m_C1N-2", "12 aa GS Linker_NO-2", "6xHIS_OD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "8-R0040-2", "parts": ["R0040_AB-2", "B0034m_BC-2", "3xFLAG_CC1-2", "E0040m_C1N-2", "12 aa GS Linker_NO-2", "6xHIS_OD-2", "B0015_DE-2", "DVK_AE-2"]}, {"name": "8--J23106-4", "parts": ["J23106_AB-4", "B0034m_BC-4", "3xFLAG_CC1-4", "E0040m_C1N-4", "12 aa GS Linker_NO-4", "6xHIS_OD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "8-I13453-4", "parts": ["I13453_AB-4", "B0034m_BC-4", "3xFLAG_CC1-4", "E0040m_C1N-4", "12 aa GS Linker_NO-4", "6xHIS_OD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "8-J23100-4", "parts": ["J23100_AB-4", "B0034m_BC-4", "3xFLAG_CC1-4", "E0040m_C1N-4", "12 aa GS Linker_NO-4", "6xHIS_OD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "8-J23102-4", "parts": ["J23102_AB-4", "B0034m_BC-4", "3xFLAG_CC1-4", "E0040m_C1N-4", "12 aa GS Linker_NO-4", "6xHIS_OD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "8-J23103-4", "parts": ["J23103_AB-4", "B0034m_BC-4", "3xFLAG_CC1-4", "E0040m_C1N-4", "12 aa GS Linker_NO-4", "6xHIS_OD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "8-J23107-4", "parts": ["J23107_AB-4", "B0034m_BC-4", "3xFLAG_CC1-4", "E0040m_C1N-4", "12 aa GS Linker_NO-4", "6xHIS_OD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "8-J23116-4", "parts": ["J23116_AB-4", "B0034m_BC-4", "3xFLAG_CC1-4", "E0040m_C1N-4", "12 aa GS Linker_NO-4", "6xHIS_OD-4", "B0015_DE-4", "DVK_AE-4"]}, {"name": "8-R0040-4", "parts": ["R0040_AB-4", "B0034m_BC-4", "3xFLAG_CC1-4", "E0040m_C1N-4", "12 aa GS Linker_NO-4", "6xHIS_OD-4", "B0015_DE-4", "DVK_AE-4"]}]
        self.reagent_to_mm = {"H12": [["reagents_plate", "H12", "5.0"], ["reagents_plate", "G12", "5.0"], ["reagents_plate", "F12", "5.0"], ["reagents_plate", "E12", "9.0"], ["reagents_plate", "D12", "5.0"], ["reagents_plate", "C12", "13.0"]], "G12": [["reagents_plate", "H12", "10"], ["reagents_plate", "G12", "10"], ["reagents_plate", "F12", "10"], ["reagents_plate", "E12", "18"], ["reagents_plate", "D12", "10"], ["reagents_plate", "C12", "26"]], "F12": [["reagents_plate", "H12", "20"], ["reagents_plate", "G12", "20"], ["reagents_plate", "F12", "20"], ["reagents_plate", "E12", "36"], ["reagents_plate", "D12", "20"]], "E12": [["reagents_plate", "C12", "52"]], "A1": [["trough", "H12", "125.0"], ["trough", "G12", "125.0"], ["trough", "F12", "125.0"], ["trough", "E12", "117.0"], ["trough", "D12", "65.0"], ["trough", "C12", "13.0"]]}
        self.master_mix_dicts = [{"well": "H12", "no_parts": 2, "vol_per_assembly": 16, "combinations": ["2-E0040m-1", "2-C0012m-1", "2-C0040-1", "2-C0062-1", "2-C0080-1", "2-E0030-1", "2-E1010m-1", "2-deGFP-1"], "no_assemblies": 8, "buffer_vol": 20, "ligase_vol": 5.0, "enzyme_vol": 10, "water_vol": 125.0, "plate": "reaction_plate"}, {"well": "G12", "no_parts": 2, "vol_per_assembly": 16, "combinations": ["2-E0040m-2", "2-C0012m-2", "2-C0040-2", "2-C0062-2", "2-C0080-2", "2-E0030-2", "2-E1010m-2", "2-deGFP-2"], "no_assemblies": 8, "buffer_vol": 20, "ligase_vol": 5.0, "enzyme_vol": 10, "water_vol": 125.0, "plate": "reaction_plate"}, {"well": "F12", "no_parts": 2, "vol_per_assembly": 16, "combinations": ["2-E0040m-4", "2-C0012m-4", "2-C0040-4", "2-C0062-4", "2-C0080-4", "2-E0030-4", "2-E1010m-4", "2-deGFP-4"], "no_assemblies": 8, "buffer_vol": 20, "ligase_vol": 5.0, "enzyme_vol": 10, "water_vol": 125.0, "plate": "reaction_plate"}, {"well": "E12", "no_parts": 5, "vol_per_assembly": 10, "combinations": ["5-J23106-1", "5-I13453-1", "5-J23100-1", "5-J23102-1", "5-J23103-1", "5-J23107-1", "5-J23116-1", "5-R0040-1", "5-J23106-2", "5-I13453-2", "5-J23100-2", "5-J23102-2", "5-J23103-2", "5-J23107-2", "5-J23116-2", "5-R0040-2"], "no_assemblies": 16, "buffer_vol": 36, "ligase_vol": 9.0, "enzyme_vol": 18, "water_vol": 117.0, "plate": "reaction_plate"}, {"well": "D12", "no_parts": 5, "vol_per_assembly": 10, "combinations": ["5-J23106-4", "5-I13453-4", "5-J23100-4", "5-J23102-4", "5-J23103-4", "5-J23107-4", "5-J23116-4", "5-R0040-4"], "no_assemblies": 8, "buffer_vol": 20, "ligase_vol": 5.0, "enzyme_vol": 10, "water_vol": 65.0, "plate": "reaction_plate"}, {"well": "C12", "no_parts": 8, "vol_per_assembly": 4, "combinations": ["8--J23106-1", "8-I13453-1", "8-J23100-1", "8-J23102-1", "8-J23103-1", "8-J23107-1", "8-J23116-1", "8-R0040-1", "8--J23106-2", "8-I13453-2", "8-J23100-2", "8-J23102-2", "8-J23103-2", "8-J23107-2", "8-J23116-2", "8-R0040-2", "8--J23106-4", "8-I13453-4", "8-J23100-4", "8-J23102-4", "8-J23103-4", "8-J23107-4", "8-J23116-4", "8-R0040-4"], "no_assemblies": 24, "buffer_vol": 52, "ligase_vol": 13.0, "enzyme_vol": 26, "water_vol": 13.0, "plate": "reaction_plate"}]

    def tearDown(self):
        pass

    def test_generate_plate_maps(self):
        dna_source = os.path.join(TEST_DIR, 'testfiles/input-dna-map.csv')
        dna_dict = moclo_transform_generator.generate_plate_maps(dna_source)
        self.assertDictEqual(dna_dict, self.dna_plate_map_dict)

    def test_generate_combinations(self):
        comb_source = os.path.join(
            TEST_DIR, 'testfiles/combination-to-make-72.csv')
        comb_dicts = moclo_transform_generator.generate_combinations(
            comb_source)
        self.assertListEqual(comb_dicts, self.combinations_to_make)

    def test_check_number_of_combinations(self):
        with self.assertRaises(ValueError):
            moclo_transform_generator.check_number_of_combinations(
                'afjkdl', self.combinations_to_make)
        with self.assertRaises(ValueError):
            moclo_transform_generator.check_number_of_combinations(
                '', self.combinations_to_make)
        comb2 = self.combinations_to_make + self.combinations_to_make
        with self.assertRaises(ValueError):
            moclo_transform_generator.check_number_of_combinations(
                'single', comb2)
        with self.assertRaises(ValueError):
            moclo_transform_generator.check_number_of_combinations(
                'triplicate', self.combinations_to_make)


if __name__ == "__main__":
    unittest.main()